name: Tests

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  syntax-check:
    name: Syntax & Import Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install fastapi uvicorn pydantic pydantic-settings python-dotenv pillow

    - name: Check Python syntax
      run: |
        python -m py_compile camera_service/*.py
        python -m py_compile main.py

    - name: Test imports (without camera hardware)
      run: |
        # Test that all modules can be imported (mocking picamera2)
        python -c "
        import sys
        from unittest.mock import MagicMock
        sys.modules['picamera2'] = MagicMock()
        sys.modules['picamera2.encoders'] = MagicMock()
        sys.modules['picamera2.outputs'] = MagicMock()

        # Now test imports
        from camera_service import config
        from camera_service import exceptions
        print('âœ“ All modules imported successfully')
        "

  code-quality:
    name: Code Quality (Optional)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black ruff mypy || true

    - name: Check formatting with Black
      run: |
        black --check camera_service tests || echo "âš  Run 'black camera_service tests' to format"
      continue-on-error: true

    - name: Lint with Ruff
      run: |
        ruff check camera_service tests || echo "âš  Run 'ruff check camera_service tests --fix' to lint"
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Run Bandit security scan
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]
        bandit -r camera_service -ll || echo "âš  Security scan completed"
      continue-on-error: true

  integration-tests-note:
    name: Hardware Tests Info
    runs-on: ubuntu-latest

    steps:
    - name: Display hardware test info
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“· Full integration tests require Raspberry Pi hardware"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "To run complete tests on Raspberry Pi:"
        echo "  1. Clone the repository on your Raspberry Pi"
        echo "  2. Run: ./scripts/test-api-v2.sh"
        echo "  3. Or run: pytest tests/ -v"
        echo ""
        echo "CI tests verify syntax, imports, and code quality only."
        echo "Hardware-dependent features are tested manually."
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
